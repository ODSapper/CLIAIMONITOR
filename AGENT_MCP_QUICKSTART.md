# Agent MCP Connection Quick Start

## Requirements

- CLIAIMONITOR server running on localhost:3000
- Claude Code CLI installed
- Windows Terminal or WezTerm (for spawning)

## Quick Test: Connect Your Agent

### Option 1: Via Dashboard API (Automated)

**Spawn a new agent that auto-connects:**

```bash
curl -X POST http://localhost:3000/api/agents/spawn \
  -H "Content-Type: application/json" \
  -d '{
    "config_name": "HaikuGreen",
    "project_path": "C:\\Users\\Admin\\Documents\\VS Projects\\CLIAIMONITOR",
    "task": "Call register_agent to test MCP connectivity"
  }'
```

This will:
1. Generate a unique agent ID (e.g., `team-haikugreen001`)
2. Create MCP config file
3. Spawn WezTerm window
4. Agent will auto-run: `claude --model claude-3-5-haiku-20241022 "{prompt}"`

### Option 2: Manual Setup (For Testing)

If running Claude Code manually:

```bash
# 1. Configure MCP
claude mcp add --transport sse cliaimonitor \
  http://localhost:3000/mcp/sse \
  --header "X-Agent-ID: test-agent-001" \
  --header "X-Project-Path: C:\\Users\\Admin\\Documents\\VS Projects\\CLIAIMONITOR"

# 2. Run Claude
claude --model claude-3-5-haiku-20241022 \
  "First, call mcp__cliaimonitor__register_agent with agent_id='test-agent-001' and role='test'. Then wait for instructions."
```

### Option 3: Via cURL (Direct Connection Test)

```bash
# Test the SSE endpoint
curl -N -H "X-Agent-ID: test-agent-001" \
     http://localhost:3000/mcp/sse
```

Expected response:
```
event: endpoint
data: /mcp/messages/?session_id=<UUID>
```

---

## What Your Agent Should Do on Connect

1. **Register itself** - Call `register_agent` tool:
```
Tool Call: mcp__cliaimonitor__register_agent
Parameters:
  - agent_id: "team-sntgreen001"
  - role: "Go Developer"
```

2. **Report initial status** - Call `report_status` tool:
```
Tool Call: mcp__cliaimonitor__report_status
Parameters:
  - status: "connected"
  - current_task: "Waiting for task assignment"
```

3. **Start working** - Accept tasks or wait for `wait_for_events`

---

## Available MCP Tools

### Registration & Status
- **register_agent** - Identify yourself to the dashboard
- **report_status** - Update your current activity
- **report_metrics** - Send token usage and test results
- **log_activity** - Log general activity

### Task Management
- **get_my_tasks** - Get tasks assigned to you
- **claim_task** - Claim a pending unassigned task
- **update_task_progress** - Update task status (in_progress, blocked)
- **complete_task** - Mark task as complete

### Collaboration
- **wait_for_events** - Wait for real-time events (new task, message, etc.)
- **request_human_input** - Ask a human a question
- **request_stop_approval** - Request permission before stopping

### Memory & Learning
- **store_knowledge** - Save solutions for future use
- **search_knowledge** - Find similar past solutions
- **record_episode** - Log what happened this session
- **search_episodes** - Find past similar situations

### Communication
- **send_to_agent** - Send message to another agent
- **signal_captain** - Signal Captain for attention
- **get_captain_messages** - Poll for human messages

### Advanced (Special Agents Only)
- **escalate_alert** - Create alerts (Supervisor/Captain)
- **submit_judgment** - Record decisions (Supervisor/Captain)
- **submit_recon_report** - Submit findings (Snake reconnaissance)

---

## Agent ID Format

Generated by spawner: `team-{configname}{sequence}`

Examples:
- `team-haikugreen001`
- `team-sntpurple002`
- `team-opusred003`
- `team-snake001`

Your agent ID is:
1. Passed in initial prompt during spawn
2. Used as `X-Agent-ID` header when connecting to MCP
3. Provided to all tool calls automatically by Claude Code

---

## Configuration File (Auto-Generated)

When spawned, the system creates: `configs/mcp/{agentID}-mcp.json`

```json
{
  "mcpServers": {
    "cliaimonitor": {
      "type": "sse",
      "url": "http://localhost:3000/mcp/sse",
      "headers": {
        "X-Agent-ID": "team-haikugreen001",
        "X-Project-Path": "C:\\path\\to\\project",
        "X-Access-Level": "user"
      }
    }
  }
}
```

Claude Code CLI reads this and auto-configures the MCP connection.

---

## Troubleshooting

### Agent doesn't connect?

Check:
1. Server is running: `curl http://localhost:3000/api/health`
2. MCP endpoint responds: `curl -H "X-Agent-ID: test" http://localhost:3000/mcp/sse`
3. Agent ID is correct in headers
4. Claude Code CLI is installed: `claude --version`

### Tool calls return errors?

1. Check server logs for `[MCP]` messages
2. Verify tool name is spelled correctly (underscore format: `mcp__cliaimonitor__toolname`)
3. Check tool parameters match the schema
4. Verify agent is actually connected (not just spawned)

### Agent spawns but immediately exits?

1. Check WezTerm window for error messages
2. Verify Claude Code CLI is in PATH: `which claude`
3. Check project path is valid and writable
4. Verify model name exists and is available

---

## Example: Minimal Working Agent

```
Initial Prompt:
"You are agent 'team-test001' with role 'tester'.
First, call mcp__cliaimonitor__register_agent with agent_id='team-test001' and role='tester'.
Then call mcp__cliaimonitor__report_status with status='connected' and current_task='waiting for assignment'.
Wait for events using wait_for_events, then execute any task that arrives.
Use mcp__cliaimonitor__complete_task when done."
```

This agent will:
1. Register on startup
2. Report status
3. Wait for task assignment
4. Complete tasks when they arrive
5. Report completion

---

## Dashboard Integration

Once agents connect:

1. **Dashboard shows agent status**: http://localhost:3000
2. **Real-time metrics** appear under agent cards
3. **Alert system** notifies of problems
4. **Human input queue** displays questions
5. **Chat** at top lets you message Captain/agents

---

## API Reference

### Spawning Agent
```
POST /api/agents/spawn
Content-Type: application/json

{
  "config_name": "HaikuGreen|SNTGreen|OpusGreen|etc",
  "project_path": "/path/to/project",
  "task": "Optional initial task description"
}

Response:
{
  "id": "team-haikugreen001",
  "config_name": "HaikuGreen",
  "role": "Go Developer",
  "model": "claude-3-5-haiku-20241022",
  "status": "starting",
  "pid": 12345,
  "spawned_at": "2025-12-21T00:00:00Z"
}
```

### Stopping Agent
```
POST /api/agents/{id}/stop

Response:
{ "success": true }
```

### Getting Agent Status
```
GET /api/state

Response includes:
{
  "agents": {
    "team-haikugreen001": {
      "id": "team-haikugreen001",
      "status": "connected",
      "last_seen": "2025-12-21T00:00:00Z",
      "metrics": { ... }
    }
  }
}
```

---

## For Captain Agents

If running as Captain (supervisor agent):

```json
{
  "mcpServers": {
    "cliaimonitor": {
      "type": "sse",
      "url": "http://localhost:3000/mcp/sse",
      "headers": {
        "X-Agent-ID": "Captain",
        "X-Access-Level": "admin"
      }
    }
  }
}
```

Captain has access to all tools including:
- `get_agent_metrics` - View all agent metrics
- `get_pending_questions` - Check human input queue
- `respond_stop_request` - Approve/deny agent stops
- `dispatch_task` - Assign work to other agents
- `get_captain_messages` - Poll for human commands

---

## Working Directory

All agents work within their configured project path. Files created will be saved there.

When calling file operation tools, paths are relative to project directory or absolute.

---

## Next Steps

1. **Install Claude Code CLI**
   ```bash
   npm install -g @anthropic-ai/claude
   ```

2. **Start CLIAIMONITOR**
   ```bash
   go run ./cmd/cliaimonitor/main.go
   ```

3. **Spawn an agent**
   ```bash
   curl -X POST http://localhost:3000/api/agents/spawn \
     -H "Content-Type: application/json" \
     -d '{"config_name":"HaikuGreen","project_path":"C:\\path","task":"Test MCP"}'
   ```

4. **Watch dashboard**
   - Open http://localhost:3000
   - See agent appear in grid
   - Watch for connection status change to "connected"

---

## Support

For issues with:
- **MCP Connectivity**: Check MCP_SSE_CONNECTIVITY_TEST.md
- **Agent Spawning**: Check spawner logs in server console
- **Tool Execution**: Check server logs for `[MCP]` messages
- **Dashboard**: Check browser console for JS errors
